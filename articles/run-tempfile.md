---
title: "Cloud Runä¸Šã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã¨ãã¯ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã«æ°—ã‚’ã¤ã‘ã‚‹"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cloudrun", "golang"]
published: false
---

## ã¯ã˜ã‚ã«

Cloud Runã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ä»¥ä¸‹ã®è¨˜è¿°ãŒã‚ã‚‹ã®ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

> **ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹**
> 
> å„ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã¯æ›¸ãè¾¼ã¿å¯èƒ½ã§ã€æ¬¡ã®å‹•ä½œã®å½±éŸ¿ã‚’å—ã‘ã¾ã™ã€‚
> - ã“ã‚Œã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹ãŸã‚ã€**æ›¸ãè¾¼ã¿ã«ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ãƒ¢ãƒªãŒä½¿ç”¨ã•ã‚Œã¾ã™**ã€‚
> - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåœæ­¢ã™ã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã›ã‚“ã€‚

å‡ºå…¸: [ã‚³ãƒ³ãƒ†ãƒŠ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å¥‘ç´„](https://cloud.google.com/run/docs/container-contract?hl=ja#filesystem)

> **HTTP 500 / HTTP 503: ã‚³ãƒ³ãƒ†ãƒŠ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãƒ¡ãƒ¢ãƒªã®ä¸Šé™ã‚’è¶…ãˆã¦ã„ã‚‹**
> (...ä¸­ç•¥...)
> Cloud Run ã§ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ« ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯**ä½¿ç”¨å¯èƒ½ãªãƒ¡ãƒ¢ãƒªã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™**ã€‚ã“ã‚Œã«ã¯ã€/var/log/* ã¨ /dev/log ä»¥å¤–ã®å ´æ‰€ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã¾ã‚Œã¾ã™ã€‚

å‡ºå…¸: [Cloud Run ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](https://cloud.google.com/run/docs/troubleshooting?hl=ja#memory)

ã“ã®è¨˜äº‹ã¯ã€Goã§æ›¸ã„ãŸæ¤œè¨¼ç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’Cloud Runä¸Šã§å‹•ã‹ã—ã¤ã¤ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã®æŒ™å‹•ã‚’ç¢ºèªã—ãŸè¨˜éŒ²ã§ã™ã€‚

ãªãŠã€æœ¬è¨˜äº‹ã®å†…å®¹ã¯â†“ã®è¨˜äº‹ã§æ—¢ã«èª¿æŸ»ã•ã‚Œã¦ãŠã‚Šå‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸğŸ™
https://zenn.dev/yamato_sorariku/articles/7adb5818579df7

## TL;DR

- å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã€Cloud Runä¸Šã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã¿ã¨ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å‰²ã‚Šå½“ã¦ãŸãƒ¡ãƒ¢ãƒªãŒæ¶ˆè²»ã•ã‚Œã‚‹ã€‚
- å‰²å½“ãƒ¡ãƒ¢ãƒªã‚’ä¸€æ°—ã«è¶…ãˆã‚‹ã‚µã‚¤ã‚ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€æŒ‡æ¨™ã€Œã‚³ãƒ³ãƒ†ãƒŠãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã€ã«ã‚‚ç¾ã‚Œãªã„å ´åˆã‚‚ã‚ã‚‹ã€‚

## æ¤œè¨¼ç’°å¢ƒ

- Cloud Runã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  - ãƒ¡ãƒ¢ãƒª: 128MiB
  - æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: 1
  - ãã®ä»–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
- Go
  - go 1.20.7

æ¤œè¨¼ã«ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/bellwood4486/sample-go-gcp/tree/main/run/helloworld

ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ¬¡ã®ã‚ˆã†ã« `gcloud` ã§è¡Œã„ã¾ã—ãŸã€‚
```shell
$ gcloud run deploy helloworld --memory=128Mi --max-instances=1 --source .
```

## ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆæ™‚ã®ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã¯æœ¬å½“ã‹ï¼Ÿ

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚‹ã—ã€èª¿æŸ»è¨˜äº‹ã‚‚ã‚ã‚‹ã®ã§æœ¬å½“ã§ã¯ã‚ã‚‹ã®ã§ã™ãŒã€è‡ªåˆ†ã§ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®éƒ¨åˆ†ã§ã™ã€‚  
1KBåˆ†ã®é©å½“ãªãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’ã€æŒ‡å®šã—ãŸã‚µã‚¤ã‚ºåˆ†(MB)ã ã‘æ›¸ãè¾¼ã‚€ã ã‘ã§ã™ã€‚
```go
func createDummyFile(dir string, sizeInMB int) error {
	f, err := os.CreateTemp(dir, dummyFilePrefix)
	if err != nil {
		return err
	}

	b := make([]byte, 1*KB)
	if _, err := rand.Read(b); err != nil {
		return err
	}
	until := sizeInMB * MB / len(b)
	for i := 0; i < until; i++ {
		if _, err := f.Write(b); err != nil {
			return err
		}
	}
	if err := f.Close(); err != nil {
		log.Fatal(err)
	}

	return nil
}
```

GETãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚„ã‚‹ã®ã¯é©åˆ‡ã§ã¯ãªã„ã§ã™ãŒã¡ã‚‡ã£ã¨æ‰‹ã‚’æŠœãã€æ¬¡ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸã‚µã‚¤ã‚ºã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚
```
GET https://{FQDN}/dummy:add?size={MB}
```

ã“ã®ä»•çµ„ã¿ã‚’ä½¿ã£ã¦æœ€å¤§ãƒ¡ãƒ¢ãƒªã‚’è¶…ãˆã•ã›ã¦ã¿ã¾ã™ã€‚

### æœ€å¤§ãƒ¡ãƒ¢ãƒªã«å¾ã€…ã«è¿‘ã¥ã‘è¶…éã•ã›ã‚‹

ã¾ãšå°ã•ã‚ãªä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¾ã€…ã«æºœã¾ã£ã¦ã„ãæƒ³å®šã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚

æœ€å¤§ãƒ¡ãƒ¢ãƒª128MiBã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¯¾ã—ã¦ã€1MB/1ç§’ã®ãƒšãƒ¼ã‚¹ã§10åˆ†é–“ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šç¶šã‘ã¦ã¿ã¾ã™ã€‚  
å®šæœŸçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã«ã‚ãŸã£ã¦ã¯ [nakabonne/ali](https://github.com/nakabonne/ali) ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚é€ä¿¡é »åº¦ã‚„æœŸé–“ãªã©ç°¡å˜ã«æŒ‡å®šã§ãã€ã¾ãŸçµæœã‚‚è¦‹ã‚„ã™ãä¾¿åˆ©ã§ã™ã€‚

ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚
```shell
$ ali --rate=1 --duration=10m "https://{FQDN}/dummy:add?size=1"
```
:::details ã€å‚è€ƒã€‘aliã®ç”»é¢ä¾‹
![aliã®ç”»é¢ä¾‹](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/19d16d21-959d-4065-b27e-0dc6542b1b3b)
:::

å®Ÿè¡Œã®çµæœã€Cloud Runã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚(é–¢é€£ã‚ã‚‹ã‚‚ã®ã‚’æŠœç²‹)  
å®Ÿè¡Œæ™‚é–“ã¯11:21ã€œ11:31é ƒã§ã™ã€‚
![ãƒ¡ãƒ¢ãƒª](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/2640806d-4468-4b4f-afea-654af3b8878b)

ã‚µãƒ¼ãƒ“ã‚¹è‡ªèº«ã®æ¶ˆè²»ãƒ¡ãƒ¢ãƒªã‚’ç„¡è¦–ã—ãŸã¨ã™ã‚‹ã¨ã€æ¯ç§’1MBã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚‰ã‚Œã‚‹ã®ã§ã€128ç§’å¾Œã«ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ€å¤§ãƒ¡ãƒ¢ãƒªã‚’è¶…ãˆã‚‹ã¯ãšã§ã™ã€‚  
10åˆ†(600ç§’)é–“å®Ÿè¡Œã™ã‚‹ã®ã§ 600/128â‰’4.7 ã¨ãªã‚Šã€**ãƒ”ãƒ¼ã‚¯ã¯4å›ã¯è¿ãˆã‚‹**è©¦ç®—ã¨ãªã‚Šã¾ã™ã€‚

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚ãŸã—ã‹ã«4å›å±±ãŒã‚ã‚Šã€æƒ³å®šã—ãŸé€šã‚Šã®æŒ™å‹•ã‚’ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

è¨˜éŒ²ä¸Šã®å›æ•°ã¯1å›å¤šã„ã‚‚ã®ã®ã€æ¬¡ã®ã‚ˆã†ãªå½¢ã§æœ€å¤§ãƒ¡ãƒ¢ãƒª(128MiB)ã‚’è¶…éã—ãŸã“ã¨ãŒãƒ¬ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚  
ã€æ¦‚è¦ã€‘
![ãƒ¡ãƒ¢ãƒªè¶…é(æ¦‚è¦)](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/a26c8c8b-9b48-4fb6-8dd7-6bc76a156aba)
ã€è©³ç´°ã€‘
![ãƒ¡ãƒ¢ãƒªè¶…é(è©³ç´°)](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/fb6a5c56-55a7-461b-87d2-a5615ddfb2a1)

æœ€å¤§ãƒ¡ãƒ¢ãƒªè¶…éæ™‚ã®ãƒ­ã‚°ã‚‚è¦‹ã¦ã¿ã¾ã™ã€‚
![ãƒ­ã‚°](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/edc36933-2d66-4788-b8f2-c5ef4b8b3140)
ãƒ­ã‚°ã®æµã‚Œã¯æ¬¡ã®é€šã‚Šã§ã€ãƒ¡ãƒ¢ãƒªè¶…éå¾Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã•ã‚Œã€æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™
1. ãƒ¡ãƒ¢ãƒªè¶…éãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹ã€‚
2. SIGTERMã‚·ã‚°ãƒŠãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ãŒå—ã‘å–ã‚‹ã€‚
3. ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã™ã‚‹ã€‚
4. æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã‚‹ã€‚
5. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒèµ·å‹•ã™ã‚‹ã€‚

:::message
ãƒ¡ãƒ¢ãƒªè¶…éæ™‚ã®ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã«ãŠã„ã¦SIGTERMãŒé€ã‚‰ã‚Œã‚‹ã“ã¨ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã‚ãã¾ã§ã‚‚ä»Šå›ã®æ¤œè¨¼ã§ã®æŒ™å‹•ã§ã™ã€‚ã“ã®æŒ™å‹•ã‚’å‰æã¨ã—ãªã„ã‚ˆã†ãŠé¡˜ã„ã—ã¾ã™ã€‚
:::

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹æ¬¡ã®æŒ™å‹•ã¯ä»Šå›ã®æ¤œè¨¼ã§ã¯ç¢ºèªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æ¨æ¸¬ã§ã™ãŒä»Šå›ã®1rpsç¨‹åº¦ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã®åœæ­¢ã¨èµ·å‹•ãŒé–“ã«åˆã£ã¦ã—ã¾ã†ãŸã‚ç™ºç”Ÿã—ãªã‹ã£ãŸå¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚
> HTTP 500 / HTTP 503: ã‚³ãƒ³ãƒ†ãƒŠ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãƒ¡ãƒ¢ãƒªã®ä¸Šé™ã‚’è¶…ãˆã¦ã„ã‚‹

### æœ€å¤§ãƒ¡ãƒ¢ãƒªã‚’ä¸€æ°—ã«è¶…éã•ã›ã‚‹

ã§ã¯æ¬¡ã«ã€æœ€å¤§ãƒ¡ãƒ¢ãƒªã‚’è¶…ãˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä½œã‚Šã€ãã®éš›ã®æŒ™å‹•ã‚’è¦‹ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

æœ€å¤§ãƒ¡ãƒ¢ãƒª(128MiB)ã‚’è¶…ãˆã‚‹150MBã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã¿ã¾ã™ã€‚
```
GET https://{FQDN}/dummy:add?size=150
```
å®Ÿæ–½æ™‚é–“ã¯ 12:36 ä»˜è¿‘ã§ã™ã€‚

å®Ÿè¡Œã™ã‚‹ã¨ã™ãæ¬¡ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚
![ãƒ¡ãƒ¢ãƒªè¶…é(æ¦‚è¦)](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/120e7d69-16a9-47bb-981d-22af48b05faa)

ä»Šå›ãŒãŸã¾ãŸã¾ãªå¯èƒ½æ€§ã¯ã‚ã‚Šã¾ã™ãŒã€1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä¸€æ°—ã«è¶…éã™ã‚‹ã‚±ãƒ¼ã‚¹ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã«è¨˜éŒ²ãŒæ®‹ã‚‰ãªã„å ´åˆã‚‚ã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
![ãƒ¡ãƒˆãƒªã‚¯ã‚¹](https://github.com/bellwood4486/sample-go-gcp/assets/2452581/df9e1d73-353b-434c-b2b3-1a5c75fabd76)

ãƒ­ã‚°ã«ã¯æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã¦ãŠã‚Šã€æƒ³å®šé€šã‚Šã®æŒ™å‹•ã§ã—ãŸã€‚
```text
Memory limit of 128 MiB exceeded with 152 MiB used. Consider increasing the memory limit, see https://cloud.google.com/run/docs/configuring/memory-limits
```

### (ãŠã¾ã‘)å‹•ç”»

æƒ…å ±ã‚’æ¼ã£ã¦ã„ã‚‹ãªã‹ã§ã€Cloud Runä¸Šã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã—ã¦èªã‚‰ã‚Œã¦ã„å‹•ç”»ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚
https://www.youtube.com/watch?v=L3vClxcAsnY

ã“ã®å‹•ç”»ã ã¨[0:23](https://youtu.be/L3vClxcAsnY?t=23)ã‚ãŸã‚Šã§ã€æ¬¡ã®ã‚ˆã†ã«è©±ã•ã‚Œã¦ã„ã¾ã™ã€‚
>Your Cloud Run servers can write files to a temporary file system that is reset between requests

è‹±èªãŒå¾—æ„ã§ã¯ãªã„ç­†è€…ã¯ä¸€ç¬ã€Œãˆã£ï¼1ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯ã«ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã®ï¼ï¼Ÿã€ã¨æ€ã£ã¦ã—ã¾ã£ãŸã®ã§ã™ãŒã€ä¸Šè¨˜æ¤œè¨¼çµæœã‚„å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹é™ã‚Šã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹ã—æ®‹ã£ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚‹ã€ãã‚‰ã„ã®èªè­˜ã§è‰¯ã•ãã†ã§ã™ã€‚

## ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å®¹é‡ã¨ã‹ã¯ã©ã†ãªã£ã¦ã„ã‚‹ã®ã‹ï¼Ÿ

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚ˆã†ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ã“ã®ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ã‚¹ãƒ†ãƒ ã«ã¯ã‚µã‚¤ã‚ºã®ä¸Šé™ã‚’æŒ‡å®šã§ããªã„ãŸã‚ã€

å‡ºå…¸: [ã‚³ãƒ³ãƒ†ãƒŠ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å¥‘ç´„](https://cloud.google.com/run/docs/container-contract?hl=ja#filesystem)

ã§ã¯ã€å®Ÿéš›ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å®¹é‡ã‚’å–å¾—ã™ã‚‹ã¨ã©ã‚“ãªå€¤ãŒå–ã‚Œã‚‹ã®ã‹ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚(ã“ã‚Œã‚‰ã®çµæœã‚’JSONã§è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™)
```go
package main

import "syscall"

type diskUsage struct {
	// see: https://linuxjm.osdn.jp/html/LDP_man-pages/man2/statfs.2.html
	fs syscall.Statfs_t
}

func newDiskUsage(path string) (*diskUsage, error) {
	usage := &diskUsage{}
	err := syscall.Statfs(path, &usage.fs)
	if err != nil {
		return nil, err
	}
	return usage, nil
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ç·å®¹é‡ã‚’è¿”ã™
func (du *diskUsage) size() uint64 {
	return du.fs.Blocks * uint64(du.fs.Bsize)
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ç©ºãå®¹é‡ã‚’è¿”ã™
func (du *diskUsage) free() uint64 {
	return du.fs.Bfree * uint64(du.fs.Bsize)
}

// éç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ãªç©ºãå®¹é‡ã‚’è¿”ã™
func (du *diskUsage) avail() uint64 {
	return du.fs.Bavail * uint64(du.fs.Bsize)
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ç”¨é‡ã‚’è¿”ã™
func (du *diskUsage) used() uint64 {
	return du.size() - du.free()
}
```

çµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«è¨­å®šã—ãŸæœ€å¤§ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºã§ã‚‚ãªã„æ¥µã‚ã¦å¤§ããªå€¤ãŒå–ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚
```json5
{
  "size": "8589934592.00GB", // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ç·å®¹é‡
  "free": "8589934592.00GB", // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ç©ºãå®¹é‡
  "available": "8589934592.00GB", // éç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ãªç©ºãå®¹é‡
  "used": "0B" // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ç”¨é‡
}
```

è¨­å®šã—ãŸãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºã§ã‚‚ãªã„ã®ã§ã€Cloud Runä¸Šã§ã¯ã€Œ`n`MBä»¥ä¸Šã®ç©ºãå®¹é‡ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ï¼Ÿã€ã¿ãŸã„ãªãƒã‚§ãƒƒã‚¯ã¯æ„å‘³ã‚’ãªã•ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## ã¾ã¨ã‚

æ‰‹ã‚’å‹•ã‹ã—ã¦å®Ÿé¨“ã—ã¤ã¤ã€Cloud Runä¸Šã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ã¨ãã®æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã‚€ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ãƒ¢ãƒªãŒæ¶ˆè²»ã•ã‚Œã¾ã—ãŸã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸æ›¸ãè¾¼ã‚€ã‚µãƒ¼ãƒ“ã‚¹ã ã¨ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æœ€å¤§ãƒ¡ãƒ¢ãƒªã‚’è¨­è¨ˆã™ã‚‹éš›ã«è€ƒæ…®ã™ã¹ãç‚¹ãŒå¢—ãˆã¦ã—ã¾ã„ã¾ã™ã€‚
æ­´å²çš„çµŒç·¯ãªã©ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€åŸºæœ¬çš„ã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸ã®æ›¸ãè¾¼ã¿ã¯é¿ã‘ã€å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã»ã†ãŒè‰¯ã•ãã†ã§ã™ã€‚

## å‚è€ƒ

- [ã€Cloud Runã€‘ãã®ãƒ¡ãƒ¢ãƒªä¸è¶³ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å‡ºåŠ›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒåŸå› ã‹ã‚‚ã—ã‚Œãªã„è©±](https://zenn.dev/yamato_sorariku/articles/7adb5818579df7)
- [ã‚³ãƒ³ãƒ†ãƒŠ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å¥‘ç´„ | Cloud Run ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | Google Cloud](https://cloud.google.com/run/docs/container-contract?hl=ja) 
- [Cloud Run ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | Cloud Run ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | Google Cloud](https://cloud.google.com/run/docs/troubleshooting?hl=ja)
- [ã‚³ãƒ³ãƒ†ãƒŠ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é€ä¿¡ã•ã‚Œã‚‹ãƒˆãƒ©ãƒƒãƒ—çµ‚äº†ã‚·ã‚°ãƒŠãƒ«ï¼ˆSIGTERMï¼‰ | Cloud Run ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | Google Cloud](https://cloud.google.com/run/docs/samples/cloudrun-sigterm-handler?hl=ja)
- [Goè¨€èª: ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ã¡ã‚ƒã‚“ã¨ãƒã‚§ãƒƒã‚¯ã™ã‚‹å®Ÿè£…? - Qiita](https://qiita.com/suin/items/b9c0f92851454dc6d461#comment-70c188ae8ad783fe57f9)
- [How to generate random bytes with Golang?| Practical Go Lessons](https://www.practical-go-lessons.com/post/how-to-generate-random-bytes-with-golang-ccc9755gflds70ubqc2g)
- [How to get the disk usage information in Golang?](https://www.includehelp.com/golang/get-the-disk-usage-information.aspx)
- [Man page of STATFS](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/statfs.2.html)
- [gcloud run deploy | Google Cloud CLI Documentation](https://cloud.google.com/sdk/gcloud/reference/run/deploy)
- [nakabonne/ali: Generate HTTP load and plot the results in real-time](https://github.com/nakabonne/ali)
